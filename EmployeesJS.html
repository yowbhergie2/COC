function loadEmployees() {
  const db = window.db;
  const q = query(collection(db, 'employees'), orderBy('lastName'));
  const unsubscribe = onSnapshot(q, (snapshot) => {
    window.employeesData = [];
    snapshot.forEach((doc) => {
      window.employeesData.push({ id: doc.id, ...doc.data() });
    });

    populateEmployeeDropdowns();
    window.renderEmployeesTable('active');
  });
  window.unsubscribers.push(unsubscribe);
}

function populateEmployeeDropdowns() {
  const dropdowns = ['cert-employee', 'ledger-employee', 'cto-employee'];
  dropdowns.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      select.innerHTML = '<option value="">Select Employee</option>';
      window.employeesData.forEach(emp => {
        if (emp.isActive) {
          select.innerHTML += `<option value="${emp.employeeId}">${emp.lastName}, ${emp.firstName} (${emp.employeeId})</option>`;
        }
      });
    }
  });

  populateOvertimeEmployeeDropdown();
  populateHistoricalEmployeeFilterDropdown();
  renderEmployeesWithoutHistoricalBalance();
}

function populateOvertimeEmployeeDropdown() {
  const dropdown = document.getElementById('ot-employee-list');
  if (!dropdown) return;

  const activeEmployees = window.employeesData.filter(emp => emp.isActive);

  if (activeEmployees.length === 0) {
    dropdown.innerHTML = '<div class="dropdown-no-results">No active employees found</div>';
    return;
  }

  dropdown.innerHTML = activeEmployees.map(emp => `
    <div class="dropdown-item-custom" onclick="selectOvertimeEmployee('${emp.employeeId}', '${emp.lastName}, ${emp.firstName}', '${emp.office}', '${emp.position}')">
      <span class="employee-name">${emp.lastName}, ${emp.firstName}</span>
      <span class="employee-details">${emp.employeeId} • ${emp.office} • ${emp.position}</span>
    </div>
  `).join('');
}

function populateHistoricalEmployeeFilterDropdown() {
  const dropdown = document.getElementById('hist-employee-filter-list');
  if (!dropdown) return;

  const activeEmployees = window.employeesData.filter(emp => emp.isActive);

  if (activeEmployees.length === 0) {
    dropdown.innerHTML = '<div class="dropdown-no-results">No active employees found</div>';
    return;
  }

  dropdown.innerHTML = activeEmployees.map(emp => `
    <div class="dropdown-item-custom" onclick="selectHistoricalEmployeeFilter('${emp.employeeId}', '${emp.lastName}, ${emp.firstName}')">
      <span class="employee-name">${emp.lastName}, ${emp.firstName}</span>
      <span class="employee-details">${emp.employeeId} • ${emp.office} • ${emp.position}</span>
    </div>
  `).join('');
}

window.renderEmployeesTable = function(type) {
  const typesToRender = type ? [type] : ['active', 'inactive'];

  typesToRender.forEach(tabType => {
    const employees = window.employeesData.filter(emp =>
      tabType === 'active' ? emp.isActive : !emp.isActive
    );

    let filteredEmployees = employees;
    const searchTerm = window.employeeSearchTerms[tabType];

    if (searchTerm) {
      const searchLower = searchTerm.toLowerCase();
      filteredEmployees = employees.filter(emp => {
        const fullName = `${emp.firstName} ${emp.lastName}`.toLowerCase();
        const reverseName = `${emp.lastName} ${emp.firstName}`.toLowerCase();
        return fullName.includes(searchLower) ||
               reverseName.includes(searchLower) ||
               (emp.office && emp.office.toLowerCase().includes(searchLower)) ||
               (emp.position && emp.position.toLowerCase().includes(searchLower));
      });
    }

    const tableBody = document.getElementById(`${tabType}EmployeesTableBody`);

    if (filteredEmployees.length === 0) {
      const message = searchTerm ? 'No employees match your search' : `No ${tabType} employees found`;
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center">${message}</td></tr>`;
    } else {
      tableBody.innerHTML = filteredEmployees.map(emp => `
        <tr>
          <td>${emp.employeeId}</td>
          <td>${emp.lastName}, ${emp.firstName}</td>
          <td>${emp.office}</td>
          <td>${emp.position}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editEmployee('${emp.employeeId}')">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee('${emp.employeeId}')">
              <i class="bi bi-trash"></i> Delete
            </button>
          </td>
        </tr>
      `).join('');
    }
  });
};

window.filterEmployees = function(type) {
  const searchInput = document.getElementById(`search-${type}-employees`);
  const clearBtn = document.getElementById(`clear-${type}-search`);

  window.employeeSearchTerms[type] = searchInput.value;

  if (searchInput.value) {
    clearBtn.classList.add('visible');
  } else {
    clearBtn.classList.remove('visible');
  }

  window.renderEmployeesTable(type);
};

window.clearEmployeeSearch = function(type) {
  const searchInput = document.getElementById(`search-${type}-employees`);
  const clearBtn = document.getElementById(`clear-${type}-search`);

  searchInput.value = '';
  window.employeeSearchTerms[type] = '';
  clearBtn.classList.remove('visible');

  window.renderEmployeesTable(type);
};

window.resetEmployeeForm = function() {
  const form = document.getElementById('employeeForm');
  form.reset();
  form.classList.remove('was-validated');
  document.querySelectorAll('.form-control, .form-select').forEach(el => {
    el.classList.remove('is-invalid');
  });
  document.getElementById('emp-id-hidden').value = '';
  document.getElementById('emp-id-display').style.display = 'none';
  document.getElementById('employeeModalTitle').textContent = 'Add Employee';
  document.getElementById('emp-status').value = 'Active';
};

window.saveEmployee = async function() {
  const form = document.getElementById('employeeForm');
  const saveBtn = document.getElementById('saveEmployeeBtn');
  const btnText = saveBtn.querySelector('.btn-text');
  const spinner = saveBtn.querySelector('.spinner-border');
  
  document.querySelectorAll('.form-control, .form-select').forEach(el => {
    el.classList.remove('is-invalid');
  });

  const requiredFields = [
    { id: 'emp-fname', name: 'First Name' },
    { id: 'emp-lname', name: 'Last Name' },
    { id: 'emp-office', name: 'Office' },
    { id: 'emp-position', name: 'Position' },
    { id: 'emp-status', name: 'Status' }
  ];

  let hasErrors = false;
  requiredFields.forEach(field => {
    const element = document.getElementById(field.id);
    if (!element.value || element.value.trim() === '') {
      element.classList.add('is-invalid');
      hasErrors = true;
    }
  });

  if (hasErrors) {
    return;
  }

  const isUpdate = document.getElementById('emp-id-hidden').value !== '';
  const employeeId = document.getElementById('emp-id-hidden').value;
  const statusValue = document.getElementById('emp-status').value;
  
  const data = {
    firstName: document.getElementById('emp-fname').value,
    lastName: document.getElementById('emp-lname').value,
    middleName: document.getElementById('emp-mname').value,
    suffix: document.getElementById('emp-suffix').value,
    office: document.getElementById('emp-office').value,
    position: document.getElementById('emp-position').value,
    isActive: statusValue === 'Active'
  };

  try {
    saveBtn.disabled = true;
    btnText.classList.add('d-none');
    spinner.classList.remove('d-none');

    const result = await new Promise((resolve, reject) => {
      if (isUpdate) {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .updateEmployee_SERVER(employeeId, data);
      } else {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .addEmployee_SERVER(data);
      }
    });

    if (result.success) {
      const title = isUpdate ? 'Employee Updated!' : 'Employee Added!';
      const message = isUpdate 
        ? 'Employee information updated successfully.' 
        : `Employee ID: ${result.employeeId}`;
      window.Modal.success(title, message);
      bootstrap.Modal.getInstance(document.getElementById('employeeModal')).hide();
      form.reset();
    } else {
      window.Modal.error('Error', result.error);
    }
  } catch (error) {
    window.Modal.error('Error', 'Error saving employee: ' + error);
  } finally {
    saveBtn.disabled = false;
    btnText.classList.remove('d-none');
    spinner.classList.add('d-none');
  }
};

window.editEmployee = function(employeeId) {
  const emp = window.employeesData.find(e => e.employeeId === employeeId);
  if (!emp) return;

  document.getElementById('emp-id-hidden').value = employeeId;
  document.getElementById('emp-id-text').textContent = employeeId;
  document.getElementById('emp-id-display').style.display = 'block';
  document.getElementById('emp-fname').value = emp.firstName;
  document.getElementById('emp-mname').value = emp.middleName || '';
  document.getElementById('emp-lname').value = emp.lastName;
  document.getElementById('emp-suffix').value = emp.suffix || '';
  document.getElementById('emp-office').value = emp.office;
  document.getElementById('emp-position').value = emp.position;
  document.getElementById('emp-status').value = emp.isActive ? 'Active' : 'Inactive';
  
  document.getElementById('employeeModalTitle').textContent = 'Edit Employee';
  
  new bootstrap.Modal(document.getElementById('employeeModal')).show();
};

window.deleteEmployee = async function(employeeId) {
  window.Modal.confirm(
    'Delete Employee',
    'Are you sure you want to delete this employee? This action cannot be undone.',
    async function() {
      try {
        const result = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .deleteEmployee_SERVER(employeeId);
        });

        if (result.success) {
          window.Modal.success('Success!', 'Employee deleted successfully!');
        } else {
          window.Modal.error('Error', result.error);
        }
      } catch (error) {
        window.Modal.error('Error', 'Error deleting employee: ' + error);
      }
    }
  );
};

function renderEmployeesWithoutHistoricalBalance() {
  const container = document.getElementById('employees-no-hist-list');
  if (!container) return;

  const activeEmployees = window.employeesData.filter(emp => emp.isActive);

  const db = window.db;
  const q = query(
    collection(db, 'creditBatches'),
    where('source', '==', 'Historical')
  );

  onSnapshot(q, (snapshot) => {
    const employeesWithHist = new Set();
    snapshot.forEach(doc => {
      const batch = doc.data();
      employeesWithHist.add(batch.employeeId);
    });

    const employeesWithoutHist = activeEmployees.filter(emp =>
      !employeesWithHist.has(emp.employeeId)
    );

    if (employeesWithoutHist.length === 0) {
      container.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> All active employees have historical balance migrated!</span>';
    } else {
      container.innerHTML = employeesWithoutHist.map(emp => `
        <span class="badge bg-warning text-dark" style="cursor: pointer;"
              onclick="selectHistoricalEmployeeFilter('${emp.employeeId}', '${emp.lastName}, ${emp.firstName}')"
              title="Click to add historical balance for this employee">
          ${emp.lastName}, ${emp.firstName} (${emp.employeeId})
        </span>
      `).join('');
    }
  });
}

